name: Deploy Storefront

on:
  push:
    branches:
      - main # Or your primary deployment branch for storefront
    paths: # Only run if files in these paths change
      - '212storefront/**' # Adjust if it's in a monorepo, e.g., 'apps/storefront/**'
      - '.github/workflows/main.yaml'
  workflow_dispatch: # Allows manual triggering

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4 # This checks out the repo where the workflow file resides

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Specify the Node.js version your project uses
          cache: 'npm' # Optional: Caches npm dependencies
          cache-dependency-path: '212storefront/yarn.lock' # Or package-lock.json if you use npm

      - name: Install dependencies
        working-directory: ./212storefront # Specify the working directory
        run: npm install

      - name: Build storefront
        working-directory: ./212storefront # Specify the working directory
        run: npm run build

      - name: Transfer built files to EC2
        uses: appleboy/scp-action@v0.1.7 # Use SCP action to copy files
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # Source paths are now relative to the repository root, pointing into the subdirectory
          # strip_components: 1 will remove '212storefront/' from the path when copying
          source: "212storefront/.next/,212storefront/public/,212storefront/package.json,212storefront/yarn.lock" # Adjust lock file as needed
          target: "/var/www/212manager-app/212storefront" # Destination directory on EC2
          strip_components: 1 # Remove the leading directory component if copying from a subdirectory

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.0 # Or latest version
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          # The script now only handles server-side commands after files are copied
          script: |
            set -e # Exit on error
            echo "Deploying storefront to /var/www/212manager-app/212storefront..."
            cd /var/www/212manager-app/212storefront
            
            # Files are already copied by the SCP action
            echo "Files transferred to $(pwd)"
            
            echo "Creating .env file from secret..."
            echo "${{ secrets.STOREFRONT_ENV }}" > .env
            
            echo "Restarting PM2 process for 212storefront..."
            pm2 restart 212storefront
            pm2 save
            echo "Storefront deployment complete."
            pm2 list
